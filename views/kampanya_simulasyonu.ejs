<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Kampanya SimÃ¼lasyonu - SuperStep KDS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root { --sidebar-bg: #5e0000ef; --bg-color: #f3f4f6; --sidebar-active: #bc0b0bff; --accent-color: #ff0000ff; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-color); }
        .sidebar { width: 260px; background-color: var(--sidebar-bg); min-height: 100vh; position: fixed; top: 0; left: 0; padding-top: 20px; z-index: 1000; }
        .sidebar-logo { height: 72px; padding: 0 20px; display: flex; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.15); }
        .sidebar-logo-img { width: 100%; max-width: 400px; height: auto; display: block; margin: 0; }
        .sidebar-menu { list-style: none; padding: 0; }
        .menu-header { font-size: 11px; text-transform: uppercase; color: #b77a7aff; padding: 10px 24px; font-weight: 600; margin-top: 10px; }
        .menu-item a { display: flex; align-items: center; padding: 12px 24px; color: #e5e5e5ff; text-decoration: none; font-size: 14px; border-left: 3px solid transparent; }
        .menu-item a:hover, .menu-item a.active { background-color: var(--sidebar-active); color: white; border-left-color: var(--accent-color); }
        .menu-item i { width: 24px; }
        .main-content { margin-left: 260px; padding: 30px; }

        .white-card { background: white; border-radius: 12px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); margin-bottom: 24px; border: 1px solid #e5e7eb; }
        
        /* Slider ve Input Stilleri */
        input[type=range] { width: 100%; accent-color: #3b82f6; cursor: pointer; }
        
        .kds-card { border-radius: 12px; padding: 20px; border: 1px solid #e5e7eb; height: 100%; transition: 0.3s; }
        .kds-card:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(0,0,0,0.05); }
        
        .decision-badge { font-size: 14px; padding: 8px 15px; border-radius: 30px; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; }
        
        /* Radyo Buton Grubu (SÃ¼re SeÃ§imi) */
        .btn-group-custom .btn { border: 1px solid #e5e7eb; font-size: 13px; font-weight: 500; color: #6b7280; }
        .btn-group-custom .btn:hover { background-color: #f9fafb; }
        .btn-group-custom input:checked + .btn { background-color: #2563eb; color: white; border-color: #2563eb; }
    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="sidebar-logo"><img src="/images/superstep_logo.png" class="sidebar-logo-img"></div>
        <ul class="sidebar-menu">
            <li class="menu-header">GENEL</li>
            <li class="menu-item"><a href="/dashboard"><i class="fa-solid fa-house"></i> Genel Dashboard</a></li>
            <li class="menu-item"><a href="/sube-performansi"><i class="fa-solid fa-store"></i> Åube PerformansÄ±</a></li>
            <li class="menu-item"><a href="/musteri-segmentleri"><i class="fa-solid fa-users"></i> MÃ¼ÅŸteri Segmentleri</a></li>
            <li class="menu-item"><a href="/urun-analizi"><i class="fa-solid fa-box-open"></i> ÃœrÃ¼n ve Stok Analizi</a></li>
            <li class="menu-header">YÃ–NETÄ°M</li>
            <li class="menu-item"><a href="/kampanya-simulasyonu" class="active"><i class="fa-solid fa-wand-magic-sparkles"></i> Kampanya SimÃ¼lasyonu</a></li>
            <li class="menu-item"><a href="/satis-kayitlari"><i class="fa-solid fa-file-invoice"></i> SatÄ±ÅŸ KayÄ±tlarÄ±</a></li>
            <li class="menu-item"><a href="/gelecek-tahmini"><i class="fa-solid fa-arrow-trend-up"></i> Gelecek Tahmini</a></li>
            <li class="menu-header">AYARLAR</li>
            <li class="menu-item"><a href="/kullanicilar"><i class="fa-solid fa-user-gear"></i> KullanÄ±cÄ± YÃ¶netimi</a></li>
        </ul>
    </aside>

    <main class="main-content">
        
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h3 class="fw-bold text-dark m-0">Kampanya Karar Destek SimÃ¼lasyonu</h3>
                <p class="text-muted m-0" style="font-size: 14px;">Fiyat stratejilerinin uzun vadeli kÃ¢rlÄ±lÄ±k etkisini analiz edin.</p>
            </div>
            
            <div class="bg-white p-2 rounded border shadow-sm">
                <span class="small fw-bold text-muted me-2 ms-2">SÄ°MÃœLASYON SÃœRESÄ°:</span>
                <div class="btn-group btn-group-sm btn-group-custom" role="group">
                    

                    <input type="radio" class="btn-check" name="sure" id="sure6" value="6" checked onchange="hesapla()">
                    <label class="btn btn-outline-light text-dark" for="sure6">6 Ay (Taktik)</label>

                    <input type="radio" class="btn-check" name="sure" id="sure12" value="12" onchange="hesapla()">
                    <label class="btn btn-outline-light text-dark" for="sure12">12 Ay (Stratejik)</label>
                </div>
            </div>
        </div>

        <div class="row g-4">
            <div class="col-lg-4">
                <div class="white-card h-100">
                    <h5 class="fw-bold mb-4 border-bottom pb-2">ğŸ›ï¸ Kampanya Parametreleri</h5>
                    
                    <div class="mb-4">
                        <label class="form-label text-muted small fw-bold">HIZLI SENARYOLAR</label>
                        <div class="d-grid gap-2">
                            <button onclick="senaryoYukle(-20, 35)" class="btn btn-outline-primary btn-sm text-start"><i class="fa-solid fa-bolt me-2"></i>Agresif Ä°ndirim (-20% Fiyat, +35% Talep)</button>
                            <button onclick="senaryoYukle(15, -10)" class="btn btn-outline-dark btn-sm text-start"><i class="fa-solid fa-gem me-2"></i>Premium Zam (+15% Fiyat, -10% Talep)</button>
                            <button onclick="senaryoYukle(-10, 15)" class="btn btn-outline-success btn-sm text-start"><i class="fa-solid fa-tag me-2"></i>Sezon Sonu (-10% Fiyat, +15% Talep)</button>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label fw-bold d-flex justify-content-between small">
                            <span>Fiyat DeÄŸiÅŸimi</span>
                            <span id="fiyatVal" class="badge bg-primary">0%</span>
                        </label>
                        <input type="range" min="-50" max="50" value="0" id="fiyatSlider" oninput="hesapla()">
                    </div>

                    <div class="mb-4">
                        <label class="form-label fw-bold d-flex justify-content-between small">
                            <span>Beklenen Talep Etkisi</span>
                            <span id="talepVal" class="badge bg-success">0%</span>
                        </label>
                        <input type="range" min="-50" max="100" value="0" id="talepSlider" oninput="hesapla()">
                    </div>

                    <div class="alert alert-light border small text-muted">
                        <i class="fa-solid fa-circle-info me-1"></i>
                        SimÃ¼lasyon, seÃ§ilen sÃ¼re boyunca etkinin <strong>sabit kalacaÄŸÄ±</strong> veya hafifÃ§e azalacaÄŸÄ± (doygunluk) varsayÄ±mÄ±yla Ã§alÄ±ÅŸÄ±r.
                    </div>
                </div>
            </div>

            <div class="col-lg-8">
                
                <div class="row g-3 mb-4">
                    <div class="col-md-4">
                        <div class="kds-card bg-white">
                            <div class="small text-muted fw-bold text-uppercase mb-1">Toplam Tahmini KÃ¢r</div>
                            <div class="fs-4 fw-bold text-dark" id="toplamKar">---</div>
                            <div class="small mt-1" id="karFark">---</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="kds-card bg-white">
                            <div class="small text-muted fw-bold text-uppercase mb-1">KÃ¢rlÄ±lÄ±k Trend Riski</div>
                            <div class="fs-5 fw-bold" id="riskDurumu">---</div>
                            <div class="progress mt-2" style="height: 6px;">
                                <div class="progress-bar" id="riskBar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="kds-card bg-white border-primary border-2">
                            <div class="small text-primary fw-bold text-uppercase mb-1">Sistem Ã–nerisi</div>
                            <div id="kararRozeti" class="mt-1">---</div>
                            <div class="small text-muted mt-2" id="kararMetni">Analiz bekleniyor...</div>
                        </div>
                    </div>
                </div>

                <div class="white-card">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="fw-bold m-0"><i class="fa-solid fa-chart-line me-2 text-primary"></i>AylÄ±k KÃ¢r DeÄŸiÅŸimi</h6>
                        <small class="text-muted">KampanyasÄ±z (Baz) vs. KampanyalÄ± (SimÃ¼lasyon)</small>
                    </div>
                    <div style="height: 300px;">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>

            </div>
        </div>

    </main>

    <script>
        // Backend'den gelen veri
        const kategoriler = <%- JSON.stringify(kategoriler) %>;
        // AylÄ±k Baz KÃ¢r (Sabit)
        const bazAylikKar = <%= mevcutDurum.kar %>; 
        
        let chartInstance = null;

        // Sayfa YÃ¼klenince
        window.onload = function() {
            hesapla();
        };

        // HÄ±zlÄ± Senaryo
        function senaryoYukle(fiyat, talep) {
            document.getElementById('fiyatSlider').value = fiyat;
            document.getElementById('talepSlider').value = talep;
            hesapla();
        }

        // --- ANA HESAPLAMA MOTORU ---
        function hesapla() {
            // 1. Girdileri Al
            const fiyatDegisim = parseInt(document.getElementById('fiyatSlider').value);
            const talepDegisim = parseInt(document.getElementById('talepSlider').value);
            
            // SÃ¼re (Radio Button'dan al)
            const sureSecimi = document.querySelector('input[name="sure"]:checked').value;
            const sureAy = parseInt(sureSecimi);

            // Etiketleri GÃ¼ncelle
            document.getElementById('fiyatVal').innerText = (fiyatDegisim > 0 ? '+' : '') + fiyatDegisim + '%';
            document.getElementById('talepVal').innerText = (talepDegisim > 0 ? '+' : '') + talepDegisim + '%';

            // 2. SimÃ¼lasyon HesabÄ± (Tek Ay Ä°Ã§in Yeni KÃ¢rÄ± Bul)
            let yeniAylikKar = 0;

            kategoriler.forEach(kat => {
                const mevcutAdet = kat.aylik_adet; // ArtÄ±k aylÄ±k veri kullanÄ±yoruz
                const mevcutFiyat = parseFloat(kat.ort_fiyat);
                const maliyet = parseFloat(kat.ort_maliyet);

                // Yeni DeÄŸerler
                const yeniFiyat = mevcutFiyat * (1 + (fiyatDegisim / 100));
                const yeniAdet = mevcutAdet * (1 + (talepDegisim / 100));
                
                // Kategori BazlÄ± Yeni KÃ¢r
                yeniAylikKar += yeniAdet * (yeniFiyat - maliyet);
            });

            // 3. Zaman Serisi OluÅŸtur (Grafik Ä°Ã§in)
            let labels = [];
            let dataBaz = [];
            let dataSim = [];
            let toplamKumlulatifKar = 0;
            let bazKumlulatifKar = 0;

            for(let i=1; i<=sureAy; i++) {
                labels.push(i + '. Ay');
                
                // Baz Senaryo (DÃ¼mdÃ¼z devam ederse)
                dataBaz.push(bazAylikKar);
                bazKumlulatifKar += bazAylikKar;

                // SimÃ¼lasyon Senaryosu (Doygunluk Etkisi - Saturation)
                // Kampanya etkisi her ay %2 azalÄ±r varsayÄ±mÄ± (GerÃ§ekÃ§i KDS)
                const doygunlukFaktoru = 1 - ((i-1) * 0.02); 
                let oAykiKar = yeniAylikKar * (doygunlukFaktoru > 0.5 ? doygunlukFaktoru : 0.5);
                
                dataSim.push(oAykiKar);
                toplamKumlulatifKar += oAykiKar;
            }

            // 4. KDS Karar MantÄ±ÄŸÄ±
            const fark = toplamKumlulatifKar - bazKumlulatifKar;
            const yuzdeFark = (fark / bazKumlulatifKar) * 100;

            // KartlarÄ± GÃ¼ncelle
            document.getElementById('toplamKar').innerText = formatPara(toplamKumlulatifKar);
            const farkEl = document.getElementById('karFark');
            farkEl.innerHTML = fark >= 0 
                ? `<span class="text-success fw-bold"><i class="fa-solid fa-arrow-up"></i> +${formatPara(fark)}</span> (Baz senaryoya gÃ¶re)`
                : `<span class="text-danger fw-bold"><i class="fa-solid fa-arrow-down"></i> ${formatPara(fark)}</span> (Zarar)`;

            // Risk Analizi
            const riskEl = document.getElementById('riskDurumu');
            const riskBar = document.getElementById('riskBar');
            
            if (yuzdeFark > 20) {
                riskEl.innerText = "DÃ¼ÅŸÃ¼k Risk ğŸŸ¢";
                riskBar.className = "progress-bar bg-success";
                riskBar.style.width = "20%";
            } else if (yuzdeFark > 0) {
                riskEl.innerText = "Orta Risk ğŸŸ¡";
                riskBar.className = "progress-bar bg-warning";
                riskBar.style.width = "50%";
            } else {
                riskEl.innerText = "YÃ¼ksek Risk ğŸ”´";
                riskBar.className = "progress-bar bg-danger";
                riskBar.style.width = "90%";
            }

            // Net Karar Ã–nerisi
            const kararRozeti = document.getElementById('kararRozeti');
            const kararMetni = document.getElementById('kararMetni');

            if (yuzdeFark > 15) {
                kararRozeti.innerHTML = `<div class="decision-badge bg-success text-white"><i class="fa-solid fa-check"></i> UYGULA</div>`;
                kararMetni.innerText = "SimÃ¼lasyon yÃ¼ksek kÃ¢rlÄ±lÄ±k gÃ¶steriyor. Kampanya gÃ¼venle baÅŸlatÄ±labilir.";
            } else if (yuzdeFark > 0) {
                kararRozeti.innerHTML = `<div class="decision-badge bg-warning text-dark"><i class="fa-solid fa-pause"></i> DÄ°KKATLÄ° OL</div>`;
                kararMetni.innerText = "KÃ¢r marjÄ± dÃ¼ÅŸÃ¼k. Sadece mÃ¼ÅŸteri kazanÄ±mÄ± (yeni Ã¼ye) hedefliyse uygulanabilir.";
            } else {
                kararRozeti.innerHTML = `<div class="decision-badge bg-danger text-white"><i class="fa-solid fa-xmark"></i> REDDET</div>`;
                kararMetni.innerText = "Bu kampanya ÅŸirketi zarara uÄŸratÄ±r. Fiyat/Talep dengesi kÃ¢rlÄ± deÄŸil.";
            }

            // GrafiÄŸi Ã‡iz
            cizGrafik(labels, dataBaz, dataSim);
        }

        function cizGrafik(labels, dataBaz, dataSim) {
            const ctx = document.getElementById('trendChart').getContext('2d');
            if(chartInstance) chartInstance.destroy();

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Mevcut (KampanyasÄ±z)',
                            data: dataBaz,
                            borderColor: '#9ca3af',
                            borderWidth: 2,
                            pointRadius: 0,
                            fill: false
                        },
                        {
                            label: 'SimÃ¼lasyon (KampanyalÄ±)',
                            data: dataSim,
                            borderColor: '#2563eb',
                            backgroundColor: 'rgba(37, 99, 235, 0.1)',
                            borderWidth: 3,
                            borderDash: [5, 5], // Kesikli Ã‡izgi (Tahmin olduÄŸu belli olsun)
                            fill: true,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { intersect: false, mode: 'index' },
                    plugins: { 
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + Number(context.raw).toLocaleString('tr-TR') + ' â‚º';
                                }
                            }
                        }
                    },
                    scales: {
                        y: { beginAtZero: false, grid: { color: '#f3f4f6' } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        function formatPara(deger) {
            return Number(deger).toLocaleString('tr-TR', {maximumFractionDigits: 0}) + ' â‚º';
        }
    </script>
</body>
</html>